{% extends "base.html" %}

{% block content %}
<div class="password-generator-header">
    <div class="row align-items-center mb-4">
        <div class="col">
            <h1 class="display-5 fw-bold">
                <i class="fas fa-shield-alt"></i> Password Strength Checker
            </h1>
            <p class="lead text-muted">Intelligent password analysis with personalized security recommendations</p>
        </div>
    </div>
</div>

<!-- Step 1: Initial Password Check -->
<div class="row" id="step-initial">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-shield-alt"></i> Password Security Assessment
                </h5>
            </div>
            <div class="card-body">
                <p>To provide you with the best security recommendations, please enter your current password or a password you'd like to use:</p>
                
                <div class="mb-3">
                    <label for="current-password" class="form-label">Enter Password</label>
                    <div class="input-group">
                        <input type="password" class="form-control" id="current-password" placeholder="Enter your password here...">
                        <button class="btn btn-outline-secondary" type="button" id="toggle-password-visibility">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    <div class="form-text">Don't worry - your password is never stored or transmitted to our servers.</div>
                </div>
                
                <button type="button" class="btn btn-primary" onclick="evaluatePassword()">
                    <i class="fas fa-search"></i> Evaluate Password
                </button>
                
                <button type="button" class="btn btn-outline-success ms-2" onclick="skipToGenerator()">
                    <i class="fas fa-forward"></i> Skip & Generate New Password
                </button>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">How It Works</h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="d-flex align-items-center mb-2">
                        <span class="badge bg-success me-2">Strong</span>
                        <small>No questions needed</small>
                    </div>
                    <div class="d-flex align-items-center mb-2">
                        <span class="badge bg-warning me-2">Moderate</span>
                        <small>3 quick questions</small>
                    </div>
                    <div class="d-flex align-items-center">
                        <span class="badge bg-danger me-2">Weak</span>
                        <small>Enhanced security review</small>
                    </div>
                </div>
                <p class="text-muted small">Our smart system adapts to your password strength, asking only the questions you need.</p>
            </div>
        </div>
    </div>
</div>

<!-- Step 2: Security Assessment Results -->
<div class="row d-none" id="step-assessment">
    <div class="col-lg-8">
        <div class="card" id="assessment-card">
            <div class="card-header" id="assessment-header">
                <h5 class="card-title mb-0" id="assessment-title">
                    <i class="fas fa-clipboard-check"></i> Security Assessment
                </h5>
            </div>
            <div class="card-body">
                <div id="assessment-message" class="alert mb-3"></div>
                
                <!-- Security Questions (conditional) -->
                <div id="security-questions" class="d-none">
                    <h6>Security Questions</h6>
                    <p class="text-muted">Please answer these questions to personalize your security recommendations:</p>
                    <div id="questions-container"></div>
                    
                    <button type="button" class="btn btn-primary mt-3" onclick="generateWithQuestions()">
                        <i class="fas fa-key"></i> Generate Secure Password
                    </button>
                </div>
                
                <!-- Direct Actions for Strong Passwords -->
                <div id="strong-password-actions" class="d-none">
                    <button type="button" class="btn btn-success" onclick="proceedWithStrongPassword()">
                        <i class="fas fa-check"></i> Continue with This Password
                    </button>
                    <button type="button" class="btn btn-outline-primary ms-2" onclick="generateWithQuestions()">
                        <i class="fas fa-key"></i> Generate Even Stronger Password
                    </button>
                </div>
                
                <!-- Weak Password Warning -->
                <div id="weak-password-warning" class="d-none">
                    <div class="alert alert-danger">
                        <strong>⚠️ Security Warning</strong>
                        <p id="weak-warning-message"></p>
                        <div id="attempt-counter" class="small"></div>
                    </div>
                    
                    <div class="mt-3">
                        <button type="button" class="btn btn-danger" onclick="generateStrongPassword()">
                            <i class="fas fa-shield-alt"></i> Generate Strong Password
                        </button>
                        <button type="button" class="btn btn-outline-warning ms-2" onclick="improveCurrentPassword()">
                            <i class="fas fa-tools"></i> Get Improvement Tips
                        </button>
                    </div>
                </div>
                
                <!-- Friendly Negotiation Section -->
                <div id="negotiation-section" class="d-none">
                    <div class="alert alert-info">
                        <div class="d-flex align-items-start">
                            <i class="fas fa-comments text-primary me-2 mt-1"></i>
                            <div>
                                <strong>Let's find a solution that works for you!</strong>
                                <p id="negotiation-message" class="mb-0 mt-2"></p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Negotiation Options -->
                    <div id="negotiation-options" class="mt-3"></div>
                </div>
                
                <!-- Final Security Options -->
                <div id="final-options-section" class="d-none">
                    <div class="alert alert-warning">
                        <div class="d-flex align-items-start">
                            <i class="fas fa-handshake text-warning me-2 mt-1"></i>
                            <div>
                                <strong id="final-message"></strong>
                                <p id="final-suggestion" class="mb-0 mt-2"></p>
                            </div>
                        </div>
                    </div>
                    
                    <div id="final-options" class="mt-3"></div>
                </div>
                
                <!-- Security Options Selection -->
                <div id="security-options-section" class="d-none">
                    <div class="card border-success">
                        <div class="card-header bg-light">
                            <h5 class="mb-0 text-success">
                                <i class="fas fa-shield-alt"></i> Choose Your Security Layers
                            </h5>
                        </div>
                        <div class="card-body">
                            <p class="mb-3" id="security-options-intro"></p>
                            <div id="security-options-list"></div>
                            
                            <div class="mt-4 d-flex gap-2">
                                <button type="button" class="btn btn-success" onclick="acceptWithSelectedSecurity()">
                                    <i class="fas fa-check"></i> Accept with Selected Security
                                </button>
                                <button type="button" class="btn btn-outline-primary" onclick="requestConsultation()">
                                    <i class="fas fa-user-tie"></i> Talk to Security Expert
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Passphrase Option -->
                <div id="passphrase-section" class="d-none">
                    <div class="card border-primary">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-quote-left"></i> Try a Passphrase Instead
                            </h5>
                        </div>
                        <div class="card-body">
                            <p>Passphrases are easier to remember and can be just as secure!</p>
                            
                            <div class="mb-3">
                                <label class="form-label">Number of Words:</label>
                                <select class="form-select" id="word-count">
                                    <option value="3">3 words (shorter)</option>
                                    <option value="4" selected>4 words (recommended)</option>
                                    <option value="5">5 words (more secure)</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Separator:</label>
                                <select class="form-select" id="separator">
                                    <option value=" ">Space ( )</option>
                                    <option value="-">Dash (-)</option>
                                    <option value="_">Underscore (_)</option>
                                    <option value=".">Dot (.)</option>
                                </select>
                            </div>
                            
                            <button type="button" class="btn btn-primary" onclick="generatePassphrase()">
                                <i class="fas fa-magic"></i> Generate Passphrase
                            </button>
                            
                            <div id="passphrase-result" class="mt-3 d-none"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Consultation Request -->
                <div id="consultation-section" class="d-none">
                    <div class="card border-info">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-user-tie"></i> Request Security Consultation
                            </h5>
                        </div>
                        <div class="card-body">
                            <p>Our security experts can help you find the perfect solution for your needs.</p>
                            
                            <div class="mb-3">
                                <label class="form-label">How would you like to be contacted?</label>
                                <select class="form-select" id="contact-preference">
                                    <option value="email">Email</option>
                                    <option value="phone">Phone</option>
                                    <option value="chat">Live Chat</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Brief description of your needs (optional):</label>
                                <textarea class="form-control" id="consultation-message" rows="3" placeholder="Tell us about your security requirements or concerns..."></textarea>
                            </div>
                            
                            <button type="button" class="btn btn-info" onclick="submitConsultationRequest()">
                                <i class="fas fa-paper-plane"></i> Request Consultation
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Additional Security Suggestions -->
                <div id="additional-security" class="d-none mt-4">
                    <div class="card border-info">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0" id="security-enthusiasm"></h6>
                        </div>
                        <div class="card-body">
                            <p id="security-message"></p>
                            <h6>Recommended Security Layers:</h6>
                            <div id="security-suggestions"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">Password Strength</h6>
            </div>
            <div class="card-body">
                <div id="strength-display">
                    <!-- Strength meter will be populated here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Step 3: Password Generation Results -->
<div class="row d-none" id="step-results">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-key"></i> Generated Password
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-4">
                    <label class="form-label">Your New Secure Password:</label>
                    <div class="input-group">
                        <input type="password" class="form-control font-monospace" id="generated-password" readonly>
                        <button class="btn btn-outline-secondary" type="button" onclick="toggleGeneratedPasswordVisibility()">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-outline-primary" type="button" onclick="copyGeneratedPassword()">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    </div>
                </div>
                
                <div id="password-alternatives" class="mb-4">
                    <h6>Alternative Options:</h6>
                    <div id="alternatives-list"></div>
                </div>
                
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-primary" onclick="generateAnother()">
                        <i class="fas fa-refresh"></i> Generate Another
                    </button>
                    <button type="button" class="btn btn-outline-secondary" onclick="startOver()">
                        <i class="fas fa-arrow-left"></i> Start Over
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">Password Analysis</h6>
            </div>
            <div class="card-body">
                <div id="generated-strength-display">
                    <!-- Generated password strength will be shown here -->
                </div>
                
                <div id="recommendations-display" class="mt-3">
                    <!-- Recommendations will be shown here -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.password-generator-header {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    padding: 2rem;
    border-radius: 0.5rem;
    margin-bottom: 2rem;
    margin-top: 70px;
}

.question-group {
    border: 1px solid #dee2e6;
    padding: 1rem;
    border-radius: 0.5rem;
    margin-bottom: 1rem;
}

.font-monospace {
    font-family: 'Courier New', monospace;
    letter-spacing: 1px;
}

.progress-bar.bg-danger { background-color: #dc3545 !important; }
.progress-bar.bg-warning { background-color: #ffc107 !important; }
.progress-bar.bg-info { background-color: #17a2b8 !important; }
.progress-bar.bg-success { background-color: #28a745 !important; }

.alternative-password {
    font-family: 'Courier New', monospace;
    background: #f8f9fa;
    padding: 0.5rem;
    border-radius: 0.25rem;
    border: 1px solid #dee2e6;
    margin-bottom: 0.5rem;
    cursor: pointer;
}

.alternative-password:hover {
    background: #e9ecef;
}

.recommendation-item {
    background: #f8f9fa;
    padding: 0.75rem;
    border-radius: 0.25rem;
    margin-bottom: 0.5rem;
    border-left: 4px solid #007bff;
}

.strength-detail {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.25rem 0;
}

.strength-detail.good {
    color: #28a745;
}

.strength-detail.warning {
    color: #ffc107;
}

.strength-detail.danger {
    color: #dc3545;
}

/* Negotiation and Security Options Styles */
.negotiation-card {
    border: 2px solid #e3f2fd;
    transition: all 0.3s ease;
}

.negotiation-card:hover {
    border-color: #2196f3;
    box-shadow: 0 4px 12px rgba(33, 150, 243, 0.15);
}

.security-option-card {
    transition: all 0.2s ease;
}

.security-option-card:hover {
    background-color: #f8f9fa;
}

.security-option-card .form-check-input:checked + .form-check-label {
    color: #28a745;
    font-weight: 500;
}

.memory-aid-section {
    background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%);
    border-radius: 0.5rem;
    padding: 1rem;
    margin: 0.5rem 0;
}

.passphrase-display {
    background: #f8f9fa;
    border: 2px solid #28a745;
    border-radius: 0.5rem;
    padding: 1rem;
    text-align: center;
    font-size: 1.2em;
    font-weight: 500;
    color: #28a745;
}

.consultation-slots {
    background: #e3f2fd;
    border-radius: 0.5rem;
    padding: 0.75rem;
}

.security-plan-step {
    border-left: 4px solid #28a745;
    padding-left: 1rem;
    margin-bottom: 1rem;
}

.friendly-message {
    background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
    border: 1px solid #ffc107;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 1rem;
}

.security-boost-badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
}

@keyframes gentle-pulse {
    0% { opacity: 1; }
    50% { opacity: 0.8; }
    100% { opacity: 1; }
}

.gentle-highlight {
    animation: gentle-pulse 2s infinite;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let currentTier = null;
let currentQuestions = [];
let attemptCount = 0;

$(document).ready(function() {
    // Initialize password visibility toggle
    $('#toggle-password-visibility').click(function() {
        togglePasswordVisibility();
    });
    
    // Enable form validation
    enableFormValidation();
});

function evaluatePassword() {
    const password = $('#current-password').val();
    
    if (!password) {
        showError('Please enter a password to evaluate.');
        return;
    }
    
    // Show loading state
    showNotification('Evaluating password security...', 'info');
    
    $.ajax({
        url: '/password/evaluate-password',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ password: password }),
        success: function(response) {
            if (response.success) {
                displayAssessmentResults(response);
            } else {
                showError(response.error || 'Failed to evaluate password');
            }
        },
        error: function(xhr, status, error) {
            showError('Error evaluating password: ' + error);
        }
    });
}

function displayAssessmentResults(response) {
    currentTier = response.tier_info.tier;
    currentQuestions = response.questions;
    attemptCount = response.attempt_count || 0;
    
    // Hide initial step and show assessment
    $('#step-initial').addClass('d-none');
    $('#step-assessment').removeClass('d-none');
    
    // Update assessment message
    const alertClass = 'alert-' + response.tier_info.warning_level;
    $('#assessment-message')
        .removeClass('alert-success alert-warning alert-danger alert-info')
        .addClass(alertClass)
        .html('<strong>' + response.tier_info.message + '</strong>');
    
    // Display strength information
    displayStrengthInfo(response.strength_info);
    
    // Handle different tiers
    if (response.tier_info.tier === 'strong') {
        $('#strong-password-actions').removeClass('d-none');
    } else if (response.tier_info.tier === 'weak') {
        displayWeakPasswordWarning(response.tier_info, response.attempt_count);
    }
    
    // Show questions if needed
    if (response.tier_info.needs_questions && response.questions.length > 0) {
        displaySecurityQuestions(response.questions);
    }
    
    // Show additional security suggestions
    if (response.additional_security && Object.keys(response.additional_security).length > 0) {
        displayAdditionalSecurity(response.additional_security);
    }
}

function displayWeakPasswordWarning(tierInfo, attemptCount) {
    // Hide old warning and show new negotiation approach
    $('#weak-password-warning').addClass('d-none');
    
    // Check for negotiation content
    if (tierInfo.show_negotiations) {
        displayNegotiations(tierInfo, attemptCount);
    } else if (tierInfo.show_final_options) {
        displayFinalOptions(tierInfo, attemptCount);
    } else {
        // Fallback to traditional warning (shouldn't happen with new system)
        $('#weak-password-warning').removeClass('d-none');
        $('#weak-warning-message').text(tierInfo.message);
        
        if (tierInfo.blocked) {
            $('#attempt-counter').html('<strong>Account protection activated.</strong>');
            $('.btn', '#weak-password-warning').prop('disabled', false);
        } else {
            const remaining = 3 - attemptCount;
            $('#attempt-counter').html(`Attempts remaining: <strong>${remaining}</strong>`);
        }
    }
}

function displayNegotiations(tierInfo, attemptCount) {
    $('#negotiation-section').removeClass('d-none');
    $('#negotiation-message').text(tierInfo.message);
    
    if (tierInfo.negotiations) {
        const optionsContainer = $('#negotiation-options');
        optionsContainer.empty();
        
        tierInfo.negotiations.forEach((negotiation, index) => {
            const optionHtml = `
                <div class="card mb-3 border-info">
                    <div class="card-body">
                        <h6 class="card-title text-primary">
                            <i class="fas fa-lightbulb"></i> ${negotiation.title}
                        </h6>
                        <p class="card-text">${negotiation.description}</p>
                        ${negotiation.example ? `<small class="text-muted"><strong>Example:</strong> ${negotiation.example}</small>` : ''}
                        ${negotiation.benefits ? `
                            <div class="mt-2">
                                <small class="text-success"><strong>Benefits:</strong></small>
                                <ul class="small text-success mb-0">
                                    ${negotiation.benefits.map(benefit => `<li>${benefit}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        <div class="mt-3">
                            <button class="btn btn-outline-primary btn-sm" onclick="selectNegotiationOption('${negotiation.title}', ${index})">
                                <i class="fas fa-hand-pointer"></i> Try This Approach
                            </button>
                        </div>
                    </div>
                </div>
            `;
            optionsContainer.append(optionHtml);
        });
        
        // Add "none of these work" option
        optionsContainer.append(`
            <div class="text-center mt-3">
                <button class="btn btn-link text-muted" onclick="evaluatePassword()">
                    <i class="fas fa-times"></i> None of these options work for me
                </button>
            </div>
        `);
    }
}

function displayFinalOptions(tierInfo, attemptCount) {
    $('#final-options-section').removeClass('d-none');
    $('#final-message').text(tierInfo.message);
    $('#final-suggestion').text(tierInfo.suggestion);
    
    if (tierInfo.final_options) {
        const optionsContainer = $('#final-options');
        optionsContainer.empty();
        
        tierInfo.final_options.forEach((option, index) => {
            const optionHtml = `
                <div class="card mb-2">
                    <div class="card-body py-3">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <h6 class="mb-1">${option.title}</h6>
                                <small class="text-muted">${option.description}</small>
                            </div>
                            <button class="btn btn-primary btn-sm" onclick="selectFinalOption('${option.action}')">
                                <i class="fas fa-arrow-right"></i> Choose
                            </button>
                        </div>
                    </div>
                </div>
            `;
            optionsContainer.append(optionHtml);
        });
    }
}

function selectNegotiationOption(title, index) {
    if (title.includes('longer version')) {
        showNotification('Great choice! Let me help you strengthen your current password.', 'success');
        showPasswordStrengtheningTips();
    } else if (title.includes('additional security') || title.includes('One-Time Password')) {
        showNotification('Excellent! Let\'s set up additional security layers.', 'success');
        showSecurityOptions();
    } else if (title.includes('Passphrase')) {
        showNotification('Smart choice! Passphrases can be much easier to remember.', 'success');
        showPassphraseOption();
    } else if (title.includes('Biometric')) {
        showNotification('Perfect! Biometric authentication is very user-friendly.', 'success');
        showBiometricSetup();
    }
}

function selectFinalOption(action) {
    switch (action) {
        case 'generate_smart_password':
            showNotification('Let me create a secure password with memory aids!', 'success');
            generateWithMemoryAid();
            break;
        case 'accept_with_enhanced_security':
            showNotification('Great! Let\'s add security layers to protect your account.', 'success');
            showSecurityOptions();
            break;
        case 'request_consultation':
            showNotification('I\'ll connect you with our security experts.', 'info');
            showConsultationRequest();
            break;
        default:
            showNotification('Let me help you find the best solution.', 'info');
    }
}

function showSecurityOptions() {
    $('#security-options-section').removeClass('d-none');
    $('#security-options-intro').text('Choose any combination of security layers that feel comfortable to you:');
    
    // Get security options from the current additional_security data
    const securityOptions = [
        {
            id: 'two_factor',
            name: 'Two-Factor Authentication (2FA)',
            description: 'Get a code on your phone when you log in',
            difficulty: 'Easy',
            time: '2-3 minutes',
            boost: 'Very High'
        },
        {
            id: 'otp',
            name: 'One-Time Password (OTP)',
            description: 'Use your password plus unique codes via email/SMS',
            difficulty: 'Very Easy',
            time: '1 minute',
            boost: 'High'
        },
        {
            id: 'email_alerts',
            name: 'Email Notifications',
            description: 'Get alerts when someone accesses your account',
            difficulty: 'Very Easy',
            time: '30 seconds',
            boost: 'Medium'
        },
        {
            id: 'biometric',
            name: 'Biometric Authentication',
            description: 'Use fingerprint or face recognition as backup',
            difficulty: 'Easy',
            time: '1-2 minutes',
            boost: 'Very High'
        }
    ];
    
    const listContainer = $('#security-options-list');
    listContainer.empty();
    
    securityOptions.forEach(option => {
        const optionHtml = `
            <div class="card mb-2">
                <div class="card-body">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="${option.id}" id="security-${option.id}">
                        <label class="form-check-label" for="security-${option.id}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong>${option.name}</strong>
                                    <div class="text-muted small">${option.description}</div>
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-success">${option.boost} Security</span>
                                    <div class="small text-muted">${option.time} setup</div>
                                </div>
                            </div>
                        </label>
                    </div>
                </div>
            </div>
        `;
        listContainer.append(optionHtml);
    });
}

function showPassphraseOption() {
    $('#passphrase-section').removeClass('d-none');
}

function showConsultationRequest() {
    $('#consultation-section').removeClass('d-none');
}

function displaySecurityQuestions(questions) {
    $('#security-questions').removeClass('d-none');
    const container = $('#questions-container');
    container.empty();
    
    questions.forEach((question, index) => {
        const questionHtml = `
            <div class="question-group mb-3">
                <label class="form-label fw-bold">
                    <span class="badge bg-primary me-2">${index + 1}</span>
                    ${question}
                </label>
                ${getQuestionInput(question, index)}
            </div>
        `;
        container.append(questionHtml);
    });
}

function getQuestionInput(question, index) {
    const questionId = `q${index + 1}`;
    
    if (question.includes('accounts')) {
        return `
            <select class="form-select" name="${questionId}" required>
                <option value="">Select an option</option>
                <option value="1-3">1-3 accounts</option>
                <option value="4-10">4-10 accounts</option>
                <option value="10+">More than 10 accounts</option>
            </select>
        `;
    } else if (question.includes('share computers') || question.includes('password managers') || question.includes('write down')) {
        return `
            <div class="form-check">
                <input class="form-check-input" type="radio" name="${questionId}" value="yes" required>
                <label class="form-check-label">Yes</label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="radio" name="${questionId}" value="no" required>
                <label class="form-check-label">No</label>
            </div>
        `;
    } else if (question.includes('change your passwords')) {
        return `
            <select class="form-select" name="${questionId}" required>
                <option value="">Select frequency</option>
                <option value="monthly">Monthly</option>
                <option value="quarterly">Every 3 months</option>
                <option value="biannually">Every 6 months</option>
                <option value="yearly">Yearly</option>
                <option value="rarely">Rarely or never</option>
            </select>
        `;
    } else {
        return `<input type="text" class="form-control" name="${questionId}" placeholder="Your answer">`;
    }
}

function displayAdditionalSecurity(securityInfo) {
    $('#additional-security').removeClass('d-none');
    $('#security-enthusiasm').text(securityInfo.enthusiasm || 'Additional Security Recommendations');
    $('#security-message').text(securityInfo.message || '');
    
    const suggestions = $('#security-suggestions');
    suggestions.empty();
    
    if (securityInfo.primary) {
        suggestions.append(`<div class="alert alert-info"><strong>Primary:</strong> ${securityInfo.primary}</div>`);
    }
    
    if (securityInfo.secondary && securityInfo.secondary.length > 0) {
        const secondaryList = securityInfo.secondary.map(item => `<li>${item}</li>`).join('');
        suggestions.append(`<div><strong>Additional options:</strong><ul>${secondaryList}</ul></div>`);
    }
}

function displayStrengthInfo(strengthInfo) {
    const strengthHtml = `
        <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span>Password Strength</span>
                <span class="badge bg-${getStrengthClass(strengthInfo.score)}">${strengthInfo.strength}</span>
            </div>
            <div class="progress">
                <div class="progress-bar bg-${getStrengthClass(strengthInfo.score)}" 
                     style="width: ${strengthInfo.score}%"></div>
            </div>
        </div>
        
        <div class="small">
            <div class="strength-detail ${strengthInfo.has_lowercase ? 'good' : 'danger'}">
                <span>Lowercase letters</span>
                <i class="fas fa-${strengthInfo.has_lowercase ? 'check' : 'times'}"></i>
            </div>
            <div class="strength-detail ${strengthInfo.has_uppercase ? 'good' : 'danger'}">
                <span>Uppercase letters</span>
                <i class="fas fa-${strengthInfo.has_uppercase ? 'check' : 'times'}"></i>
            </div>
            <div class="strength-detail ${strengthInfo.has_numbers ? 'good' : 'danger'}">
                <span>Numbers</span>
                <i class="fas fa-${strengthInfo.has_numbers ? 'check' : 'times'}"></i>
            </div>
            <div class="strength-detail ${strengthInfo.has_symbols ? 'good' : 'warning'}">
                <span>Special characters</span>
                <i class="fas fa-${strengthInfo.has_symbols ? 'check' : 'times'}"></i>
            </div>
            <div class="strength-detail ${strengthInfo.length >= 12 ? 'good' : 'danger'}">
                <span>Length (${strengthInfo.length} chars)</span>
                <i class="fas fa-${strengthInfo.length >= 12 ? 'check' : 'times'}"></i>
            </div>
        </div>
        
        ${strengthInfo.security_recommendations && strengthInfo.security_recommendations.length > 0 ? `
            <div class="mt-2 small">
                <strong>Security Tips:</strong>
                <ul class="mb-0 mt-1">
                    ${strengthInfo.security_recommendations.map(rec => `<li>${rec}</li>`).join('')}
                </ul>
            </div>
        ` : ''}
    `;
    
    $('#strength-display').html(strengthHtml);
}

function generateWithQuestions() {
    const answers = {};
    
    // Collect answers from form
    $('#questions-container input, #questions-container select').each(function() {
        const name = $(this).attr('name');
        const value = $(this).val();
        if (name && value) {
            answers[name] = value;
        }
    });
    
    generatePassword(answers);
}

function generatePassword(answers = {}) {
    const data = {
        answers: answers,
        tier: currentTier
    };
    
    showNotification('Generating secure password...', 'info');
    
    $.ajax({
        url: '/password/generate',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: function(response) {
            if (response.success) {
                displayGeneratedPassword(response);
            } else {
                showError(response.error || 'Failed to generate password');
            }
        },
        error: function(xhr, status, error) {
            showError('Error generating password: ' + error);
        }
    });
}

function displayGeneratedPassword(response) {
    // Hide assessment and show results
    $('#step-assessment').addClass('d-none');
    $('#step-results').removeClass('d-none');
    
    // Set generated password
    $('#generated-password').val(response.password);
    
    // Display alternatives
    const alternativesList = $('#alternatives-list');
    alternativesList.empty();
    
    if (response.alternatives) {
        response.alternatives.forEach(alt => {
            alternativesList.append(`
                <div class="alternative-password" onclick="selectAlternative('${alt}')">
                    ${alt}
                </div>
            `);
        });
    }
    
    // Display strength analysis
    if (response.strength_info) {
        displayStrengthInfo(response.strength_info);
        $('#generated-strength-display').html($('#strength-display').html());
    }
    
    // Display recommendations
    if (response.recommendations && response.recommendations.reasoning) {
        const reasoningHtml = response.recommendations.reasoning
            .map(reason => `<div class="recommendation-item">${reason}</div>`)
            .join('');
        $('#recommendations-display').html('<h6>Recommendations:</h6>' + reasoningHtml);
    }
    
    showNotification('Password generated successfully!', 'success');
}

function skipToGenerator() {
    currentTier = 'moderate';
    generatePassword();
}

function proceedWithStrongPassword() {
    showNotification('Great! Your password meets high security standards.', 'success');
    // You could redirect or perform other actions here
}

function generateStrongPassword() {
    currentTier = 'weak';
    generatePassword();
}

function improveCurrentPassword() {
    // Show improvement tips based on current password analysis
    showNotification('Consider using our password generator for the best security.', 'info');
    generateStrongPassword();
}

function selectAlternative(password) {
    $('#generated-password').val(password);
    showNotification('Alternative password selected!', 'success');
}

function togglePasswordVisibility() {
    const input = $('#current-password');
    const icon = $('#toggle-password-visibility i');
    
    if (input.attr('type') === 'password') {
        input.attr('type', 'text');
        icon.removeClass('fa-eye').addClass('fa-eye-slash');
    } else {
        input.attr('type', 'password');
        icon.removeClass('fa-eye-slash').addClass('fa-eye');
    }
}

function toggleGeneratedPasswordVisibility() {
    const input = $('#generated-password');
    const button = $('button[onclick="toggleGeneratedPasswordVisibility()"] i');
    
    if (input.attr('type') === 'password') {
        input.attr('type', 'text');
        button.removeClass('fa-eye').addClass('fa-eye-slash');
    } else {
        input.attr('type', 'password');
        button.removeClass('fa-eye-slash').addClass('fa-eye');
    }
}

function copyGeneratedPassword() {
    const password = $('#generated-password').val();
    if (copyToClipboard(password)) {
        showNotification('Password copied to clipboard!', 'success');
    }
}

function generateAnother() {
    generatePassword();
}

function startOver() {
    // Reset everything and go back to initial step
    $('#step-assessment, #step-results').addClass('d-none');
    $('#step-initial').removeClass('d-none');
    $('#current-password').val('');
    currentTier = null;
    currentQuestions = [];
    attemptCount = 0;
}

function getStrengthClass(score) {
    if (score >= 80) return 'success';
    if (score >= 60) return 'info';
    if (score >= 40) return 'warning';
    return 'danger';
}

function enableFormValidation() {
    // Add any form validation logic here
}

function showError(message) {
    showNotification(message, 'danger');
}

function showNotification(message, type = 'info') {
    // Remove any existing notifications
    $('.alert-notification').remove();
    
    const alertClass = 'alert-' + (type === 'error' ? 'danger' : type);
    const notification = $(`
        <div class="alert ${alertClass} alert-dismissible fade show alert-notification" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `);
    
    $('body').prepend(notification);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        notification.alert('close');
    }, 5000);
}

function generatePassphrase() {
    const wordCount = parseInt($('#word-count').val()) || 4;
    const separator = $('#separator').val() || ' ';
    
    $.ajax({
        url: '/password/generate-passphrase',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ word_count: wordCount, separator: separator }),
        success: function(response) {
            if (response.success) {
                displayPassphraseResult(response.passphrase_info);
            } else {
                showNotification('Error generating passphrase: ' + response.error, 'error');
            }
        },
        error: function(xhr, status, error) {
            showNotification('Error generating passphrase: ' + error, 'error');
        }
    });
}

function displayPassphraseResult(passphraseInfo) {
    const resultHtml = `
        <div class="card border-success">
            <div class="card-body">
                <h6 class="text-success">Your Passphrase:</h6>
                <div class="input-group mb-3">
                    <input type="text" class="form-control font-monospace" value="${passphraseInfo.passphrase}" readonly>
                    <button class="btn btn-outline-success" onclick="copyToClipboard('${passphraseInfo.passphrase}')">
                        <i class="fas fa-copy"></i> Copy
                    </button>
                </div>
                <div class="text-success">
                    <small><strong>Memory Tip:</strong> ${passphraseInfo.memory_tip}</small>
                </div>
                <div class="mt-2">
                    <span class="badge bg-success">${passphraseInfo.estimated_strength}</span>
                    <span class="badge bg-info">${passphraseInfo.length} characters</span>
                </div>
                <div class="mt-3">
                    <button class="btn btn-success" onclick="acceptPassphrase('${passphraseInfo.passphrase}')">
                        <i class="fas fa-check"></i> Use This Passphrase
                    </button>
                    <button class="btn btn-outline-primary" onclick="generatePassphrase()">
                        <i class="fas fa-refresh"></i> Generate Another
                    </button>
                </div>
            </div>
        </div>
    `;
    
    $('#passphrase-result').html(resultHtml).removeClass('d-none');
}

function acceptWithSelectedSecurity() {
    const selectedOptions = [];
    $('#security-options-list input[type="checkbox"]:checked').each(function() {
        selectedOptions.push($(this).val());
    });
    
    if (selectedOptions.length === 0) {
        showNotification('Please select at least one security option or contact our support team.', 'warning');
        return;
    }
    
    const password = $('#current-password').val();
    
    $.ajax({
        url: '/password/accept-with-security',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ 
            password: password,
            security_options: selectedOptions
        }),
        success: function(response) {
            if (response.success) {
                displaySecurityPlan(response.security_plan);
                showNotification(response.message, 'success');
            } else {
                showNotification('Error: ' + response.error, 'error');
            }
        },
        error: function(xhr, status, error) {
            showNotification('Error setting up security: ' + error, 'error');
        }
    });
}

function displaySecurityPlan(securityPlan) {
    let planHtml = `
        <div class="card border-success mt-3">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-shield-check"></i> Your Security Setup Plan</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i> Password accepted with enhanced security!
                </div>
    `;
    
    if (securityPlan.setup_instructions && securityPlan.setup_instructions.length > 0) {
        planHtml += '<h6>Setup Instructions:</h6>';
        securityPlan.setup_instructions.forEach((instruction, index) => {
            planHtml += `
                <div class="card mb-2">
                    <div class="card-header">
                        <h6 class="mb-0">${index + 1}. ${instruction.title}</h6>
                        <small class="text-muted">Estimated time: ${instruction.estimated_time}</small>
                    </div>
                    <div class="card-body">
                        <ol class="mb-0">
                            ${instruction.steps.map(step => `<li>${step}</li>`).join('')}
                        </ol>
                    </div>
                </div>
            `;
        });
    }
    
    planHtml += `
                <div class="mt-3">
                    <button class="btn btn-primary" onclick="startOver()">
                        <i class="fas fa-home"></i> Return to Home
                    </button>
                </div>
            </div>
        </div>
    `;
    
    // Hide all other sections and show the security plan
    hideAllSections();
    $('#step-assessment .card-body').append(planHtml);
}

function submitConsultationRequest() {
    const contactPreference = $('#contact-preference').val();
    const message = $('#consultation-message').val();
    
    $.ajax({
        url: '/password/request-consultation',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ 
            contact_preference: contactPreference,
            message: message
        }),
        success: function(response) {
            if (response.success) {
                displayConsultationConfirmation(response.consultation_info);
                showNotification(response.message, 'success');
            } else {
                showNotification('Error: ' + response.error, 'error');
            }
        },
        error: function(xhr, status, error) {
            showNotification('Error requesting consultation: ' + error, 'error');
        }
    });
}

function displayConsultationConfirmation(consultationInfo) {
    const confirmationHtml = `
        <div class="card border-info mt-3">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-calendar-check"></i> Consultation Scheduled</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="fas fa-clock"></i> Expected response time: ${consultationInfo.estimated_response_time}
                </div>
                
                <h6>Available Time Slots:</h6>
                <ul class="list-group list-group-flush mb-3">
                    ${consultationInfo.available_slots.map(slot => 
                        `<li class="list-group-item">${slot}</li>`
                    ).join('')}
                </ul>
                
                <h6>Meanwhile, consider these security measures:</h6>
                <ul class="text-muted">
                    ${consultationInfo.temporary_security_recommendations.map(rec => 
                        `<li>${rec}</li>`
                    ).join('')}
                </ul>
                
                <div class="mt-3">
                    <button class="btn btn-info" onclick="showSecurityOptions()">
                        <i class="fas fa-shield-alt"></i> Set Up Temporary Security Now
                    </button>
                    <button class="btn btn-outline-secondary ms-2" onclick="startOver()">
                        <i class="fas fa-home"></i> Return to Home
                    </button>
                </div>
            </div>
        </div>
    `;
    
    hideAllSections();
    $('#step-assessment .card-body').append(confirmationHtml);
}

function hideAllSections() {
    $('#negotiation-section').addClass('d-none');
    $('#final-options-section').addClass('d-none');
    $('#security-options-section').addClass('d-none');
    $('#passphrase-section').addClass('d-none');
    $('#consultation-section').addClass('d-none');
    $('#weak-password-warning').addClass('d-none');
}

function generateWithMemoryAid() {
    // This would generate a password and show memory techniques
    showNotification('Generating a secure password with memory aids...', 'info');
    
    $.ajax({
        url: '/password/generate',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ 
            tier: 'weak',
            length: 16
        }),
        success: function(response) {
            if (response.success) {
                getMemoryAid(response.password);
            } else {
                showNotification('Error generating password: ' + response.error, 'error');
            }
        },
        error: function(xhr, status, error) {
            showNotification('Error generating password: ' + error, 'error');
        }
    });
}

function getMemoryAid(password) {
    $.ajax({
        url: '/password/get-memory-aid',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ password: password }),
        success: function(response) {
            if (response.success) {
                displayPasswordWithMemoryAid(password, response.memory_aid);
            } else {
                showNotification('Error getting memory aid: ' + response.error, 'error');
            }
        },
        error: function(xhr, status, error) {
            showNotification('Error getting memory aid: ' + error, 'error');
        }
    });
}

function displayPasswordWithMemoryAid(password, memoryAid) {
    let aidHtml = `
        <div class="card border-primary mt-3">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-brain"></i> Your Secure Password with Memory Aids</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label"><strong>Your Password:</strong></label>
                    <div class="input-group">
                        <input type="password" class="form-control font-monospace" value="${password}" readonly id="memory-password">
                        <button class="btn btn-outline-primary" onclick="toggleMemoryPasswordVisibility()">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-outline-success" onclick="copyToClipboard('${password}')">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    </div>
                </div>
                
                <h6>Memory Techniques:</h6>
    `;
    
    if (memoryAid.memory_aids) {
        memoryAid.memory_aids.forEach(aid => {
            aidHtml += `
                <div class="card mb-2">
                    <div class="card-body py-2">
                        <h6 class="mb-1 text-primary">${aid.type.replace('_', ' ').toUpperCase()}</h6>
                        <p class="mb-1">${aid.description}</p>
                        ${aid.tip ? `<small class="text-muted"><strong>Tip:</strong> ${aid.tip}</small>` : ''}
                        ${aid.example ? `<small class="text-info d-block"><strong>Example:</strong> ${aid.example}</small>` : ''}
                    </div>
                </div>
            `;
        });
    }
    
    if (memoryAid.general_tips) {
        aidHtml += `
            <h6 class="mt-3">General Tips:</h6>
            <ul class="text-muted">
                ${memoryAid.general_tips.map(tip => `<li>${tip}</li>`).join('')}
            </ul>
        `;
    }
    
    aidHtml += `
                <div class="mt-3">
                    <button class="btn btn-success" onclick="acceptGeneratedPassword('${password}')">
                        <i class="fas fa-check"></i> Accept This Password
                    </button>
                    <button class="btn btn-outline-primary" onclick="generateWithMemoryAid()">
                        <i class="fas fa-refresh"></i> Generate Another
                    </button>
                </div>
            </div>
        </div>
    `;
    
    hideAllSections();
    $('#step-assessment .card-body').append(aidHtml);
}

function toggleMemoryPasswordVisibility() {
    const passwordInput = $('#memory-password');
    const button = passwordInput.next('button');
    
    if (passwordInput.attr('type') === 'password') {
        passwordInput.attr('type', 'text');
        button.html('<i class="fas fa-eye-slash"></i>');
    } else {
        passwordInput.attr('type', 'password');
        button.html('<i class="fas fa-eye"></i>');
    }
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(function() {
        showNotification('Copied to clipboard!', 'success');
    }).catch(function(err) {
        showNotification('Failed to copy to clipboard', 'error');
    });
}

function acceptPassphrase(passphrase) {
    showNotification('Passphrase accepted! Your account is now more secure.', 'success');
    // Here you would typically redirect or show success message
    startOver();
}

function acceptGeneratedPassword(password) {
    showNotification('Password accepted! Your account is now secure.', 'success');
    // Here you would typically redirect or show success message
    startOver();
}
</script>
{% endblock %}